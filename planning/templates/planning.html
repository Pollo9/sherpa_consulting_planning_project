{% extends 'base_planning.html' %}
{% load staticfiles %}

{% block link %}
<link href="{% static 'planning/css/planning.css' %}" rel="stylesheet">
{% endblock %}

{% block content %}
<style>

  .calendar {
    margin: 40px 10px;
    padding: 0;
    font-family: Arial, Helvetica Neue, Helvetica, sans-serif;
    font-size: 14px;
  }

  #calendar {
    max-width: 900px;
    margin: 0 auto;
  }

  p{
  	margin-bottom: 0;
  }

</style>



<div class="buttons_gestion">
	<div class="titre_planning">
		<p class="titre">
			Planning 2020
		</p>
	</div>
	<span class="buttons">
		<div class="bouton_filtrer">
			<a class="buttons_gestions_indiv"  href="#" data-toggle="modal" data-target="#terms-txt">
				<div class="container_filter_button">
					<em style="" class="icon-plus icons_size"></em>
					<p style="margin-left: 9px;">
						Filtrer
					</p>
				</div>
			</a>
		</div>
		<div class="bouton_upload">
			<a class="buttons_gestions_indiv" href="#" data-toggle="modal" data-target="#terms-txt2"><em class="icon-cloud-upload icons_size"></em></a>
		</div>
		<div class="bouton_ajouter">
			<a class="buttons_gestions_indiv" href="#" data-toggle="modal" data-target="#add_mission"><em class="icon-plus icons_size"></em></a>
		</div>
	</span>
</div>
<div class="all_second_line">
	<div class="titre_buttons_mois">
		<a class="mois" id="1" href="{% url 'planning' %}#mois_1" onclick="clickOnMonth(1)" style="border-left: solid;border-left-width: 1px;border-left-color: #ddd;"><p>Janvier</p></a>
	</div>
	<div class="titre_buttons_mois">
		<a class="mois" id="2" href="{% url 'planning' %}#mois_2" onclick="clickOnMonth(2)"><p>Février</p></a>
	</div>
	<div class="titre_buttons_mois">
		<a class="mois" id="3" href="{% url 'planning' %}#mois_3" onclick="clickOnMonth(3)"><p>Mars</p></a>
	</div>
	<div class="titre_buttons_mois">
		<a class="mois" id="4" href="{% url 'planning' %}#mois_4" onclick="clickOnMonth(4)"><p>Avril</p></a>
	</div>
	<div class="titre_buttons_mois">
		<a class="mois" id="5" href="{% url 'planning' %}#mois_5" onclick="clickOnMonth(5)"><p>Mai</p></a>
	</div>
	<div class="titre_buttons_mois">
		<a class="mois" id="6" href="{% url 'planning' %}#mois_6" onclick="clickOnMonth(6)"><p>Juin</p></a>
	</div>
	<div class="titre_buttons_mois">
		<a class="mois" id="7" href="{% url 'planning' %}#mois_7" onclick="clickOnMonth(7)"><p>Juillet</p></a>
	</div>
	<div class="titre_buttons_mois">
		<a class="mois" id="8" href="{% url 'planning' %}#mois_8" onclick="clickOnMonth(8)"><p>Août</p></a>
	</div>
	<div class="titre_buttons_mois">
		<a class="mois" id="9" href="{% url 'planning' %}#mois_9" onclick="clickOnMonth(9)"><p>Septembre</p></a>
	</div>
	<div class="titre_buttons_mois">
		<a class="mois" id="10" href="{% url 'planning' %}#mois_10" onclick="clickOnMonth(10)"><p>Octobre</p></a>
	</div>
	<div class="titre_buttons_mois">
		<a class="mois" id="11" href="{% url 'planning' %}#mois_11" onclick="clickOnMonth(11)"><p>Novembre</p></a>
	</div>
	<div class="titre_buttons_mois">
		<a class="mois" id="12" href="{% url 'planning' %}#mois_12" onclick="clickOnMonth(12)"><p>Décembre</p></a>
	</div>
</div>
<div class="table" id="table">
	<!-- <div class="indicateur_mois"></div>  indicateur de chgmt de mois-->
	<div class="first_table" id="first_table">
		<span class="case_jours" id="case_jours">Jours</span>
		<!-- Les dates des jours -->
	</div>
	<div class="consultants_grids" id="grids">
		<!-- Les consultants -->
		<span class="second_table" id="table_consultants"></span>
		<!-- Toutes les cases  -->
	</div>
</div>

<div class="modal fade" id="add_mission" tabindex="-1" role="dialog" aria-labelledby="termsLabel" aria-hidden="true">
	<div class="modal-dialog modal-dialog-centered">
		<div class="modal-content">
			<div class="modal-header">
				<h4 class="modal-title" id="termsLabel">Création de la mission </h4>
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
			</div>
			<div class="modal-body">
				<form action="{% url 'planning' %}" method="post" enctype="multipart/form-data">
				    {% csrf_token %}
				    <p>
				    	<label for="id_date_debut">Date debut&nbsp;:</label> <input type="datetime-local" name="date_debut" id="id_date_debut" maxlength="400" required="">
				    </p>
					<p>
						<label for="id_date_fin">Date fin&nbsp;:</label> <input type="datetime-local" name="date_fin" id="id_date_fin" maxlength="400" required="">
					</p>
					<p>
						<label for="id_status">Status&nbsp;:</label> <select name="status" id="id_status">
						  <option value="A">En Attente</option>

						  <option value="C">En Cours</option>

						  <option value="T">Terminée</option>

						</select>
					</p>

				    {{ form.as_p }}
				    <input type="submit" name="ajouter_mission" value="Créer une misson">
				</form>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn_1" data-dismiss="modal">Fermer</button>
			</div>
		</div>
		<!-- /.modal-content -->
	</div>
	<!-- /.modal-dialog -->
</div>

{% endblock %}


{% block script %} 
<script src="{% static 'planning/js/moment-with-locales.min.js' %}"></script> <!-- import de moment.js pour les dates -->
<script type="text/javascript">
	moment.locale('fr'); // definition de l'heure française (A METTRE AU TOUT DEBUT)

	var nbre_weekend = 0;//permet le fonctionnement du chargement de données

	var nombre_jours_affiches_futur = 200;
	var nombre_jours_affiches_passe = -200;

	// permet le fonctionnement de la fonction "on arrive sur ojd quand on charge la page"
	let jours_lettres_ojd = moment().format("ddd");
	
	if(jours_lettres_ojd[0] == 'd'){ // si on est dimanche on avance de 2 jours pour afficher lundi qui arrive
		var today = 1;
	}
	else if(jours_lettres_ojd[0] == 's'){ // si on est samedi on avance de 1 jour pour afficher lundi qui arrive
		var today = 2;
	}
	else{
		var today = 0; //sinon on scroll sur le jour meme
	}
	


	// Affichage des consultants dans la barre du dessus
	{% for consultant in consultants %}
			var new_code_consultants = [`<div class="consultants">` + "{{ consultant.user_django.prenom }} " + "{{ consultant.user_django.nom }}"+ `</div>`];
			new_code_consultants.push();
			document.getElementById("table_consultants").insertAdjacentHTML('beforeend',new_code_consultants);
	{% endfor %}

	

	// mettre en couleur le mois ou on se trouve
	let date = moment().format("M");
	document.getElementById(date).className += " this_month";

	var no_line = [`<div class="no_line"><label style="opacity:0;">Invisible</label></div>`];
	
	function loadTab(nombre_jours_affiches_passe, nombre_jours_affiches_futur, start_or_end){
		for (let i = nombre_jours_affiches_passe ; i < nombre_jours_affiches_futur; i++) { // nombre de jours chargés
			// PARENTS D'UNE LIGNE -> ON Y FOUT LES CASES APRES
			var parent_line_grid = [`<div class="line_grids" id="line_grids` + i + `"></div>`];
			parent_line_grid.push();
			document.getElementById("grids").insertAdjacentHTML(start_or_end, parent_line_grid);
		
			// variables pour les dates
		  	let jours_lettres = moment().add(i,'days').format("dddd"); // ex : lun.
		  	let jours_chiffres = moment().add(i,'days').format("DD"); // 01,02,...,31
		  	let mois = moment().add(i,'days').format("MM"); // 01,02,...,12
		  	let mois_one_num = moment().add(i,'days').format("M"); // 1,2,...,12
		  	let annee = moment().add(i,'days').format("YYYY"); // 98,99,00,...,19,20

		  	var nbr_missions = 0;
		  	var nbr_mission_oneDay = 0;
		  	var nbr_mission_oneDay_max = 0;
		  	var date_mission_case = annee.toString() + '-'+  mois.toString() + '-' + jours_chiffres.toString();

		  	var consultant_mission_bdd = "";


		  	// on cherche a savoir le nbr de missions maximale contenu dans une journée pour adapter la taille des cases
		  	{% for consultant in consultants %}
		  		var consultant_mission_bdd = '';
		  		{% for mission in missions %}		  			
		  			var date_heure_debut_mission_bdd = "{{ mission.date_debut }}"; // DATE + HEURE DE LA MISSION DANS LA BASE DE DONNEE (2020-02-26 17:30:00)
		  			var date_debut_mission_bdd = date_heure_debut_mission_bdd.substring(0,10); //ON RECUPERE QUE LA DATE (2020-02-26)
		  			
		  			var consultant_mission_case = "{{ consultant.user_django.prenom }} " + "{{ consultant.user_django.nom }}";
		  			var consultant__mission_today_bdd = "{{ mission.consultant.user_django.prenom }} " + "{{ mission.consultant.user_django.nom }}";
		  			if (date_mission_case == date_debut_mission_bdd && (consultant__mission_today_bdd == consultant_mission_bdd && consultant_mission_case == consultant__mission_today_bdd || nbr_mission_oneDay == 0 && consultant_mission_case == consultant__mission_today_bdd)) { // FONCTIONNE SI L'ORDRE DE LA BASE C'EST EN FONCTION DE DATE_DEBUT ET CONSULTANT
						nbr_mission_oneDay += 1;
					}
					consultant_mission_bdd = consultant__mission_today_bdd;
				{% endfor %}
				nbr_mission_oneDay_max = Math.max(nbr_mission_oneDay, nbr_mission_oneDay_max);
				nbr_mission_oneDay = 0;

			{% endfor %}

			
			var height_ligne = nbr_mission_oneDay_max * 56 + nbr_mission_oneDay_max;
			if(nbr_mission_oneDay_max == 0 || nbr_mission_oneDay_max == 1)
				height_ligne = 56 + nbr_mission_oneDay_max ;

			
		  	// CASES DANS UNE LIGNE
		  	{% for consultant in consultants %}
		  		var present = false;
		  		var one_mission_grid = [];
		  		{% for mission in missions %}

		  			nbr_missions += 1; //fonction modifs mission
		  			var date_mission_case = annee.toString() + '-'+  mois.toString() + '-' + jours_chiffres.toString(); // DATE DE LA LIGNE DU PLANING OU ON SE SITUE
		  			var date_heure_debut_mission_bdd = "{{ mission.date_debut }}"; // DATE + HEURE DE LA MISSION DANS LA BASE DE DONNEE (2020-02-26 17:30:00)
		  			var date_heure_fin_mission_bdd = "{{ mission.date_fin }}";
		  			var date_debut_mission_bdd = date_heure_debut_mission_bdd.substring(0,10); //ON RECUPERE QUE LA DATE (2020-02-26)

		  			var consultant_mission_case = "{{ consultant.user_django.prenom }} " + "{{ consultant.user_django.nom }}";
		  			var consultant_mission_bdd = "{{ mission.consultant.user_django.prenom }} " + "{{ mission.consultant.user_django.nom }}";
		  			var missions_status_bdd = "{{ mission.status }}";

		  			var heures_debutFin_missions_bdd = date_heure_debut_mission_bdd.substring(12,16) + " - " + date_heure_fin_mission_bdd.substring(12,16);

		  			if (date_mission_case == date_debut_mission_bdd && consultant_mission_case == consultant_mission_bdd) {
						var present = true;
						var nom_mission = "{{ mission.client }}"; //PERMET D'AFFICHER LE NOM DE LA MISSION SUR LE PLANNING
						var id_mission = "{{ mission.id }}"; //MODIFIER UNE MISSION
						if(missions_status_bdd == "A"){
							one_mission_grid.push([`
								<button draggable="true" id="mission_` + id_mission + `" class="missions attente" data-toggle="modal" data-target="#add_mission">
										<div class="container_missions">
											<div class="heures_missions">` + heures_debutFin_missions_bdd + `</div>
											<div class="status">En Attente</div>
										</div>	
								</button>`]);						
						}
						else if(missions_status_bdd == "C"){
							one_mission_grid.push([`
								<button draggable="true" id="mission_` + id_mission + `" class="missions cours" data-toggle="modal" data-target="#add_mission">
										<div class="container_missions">
											<div class="heures_missions">` + heures_debutFin_missions_bdd + `</div>
											<div class="status">En Cours</div>
										</div>	
								</button>`]);
						}
						else{
							one_mission_grid.push([`
								<button draggable="true" id="mission_` + id_mission + `" class="missions terminee" data-toggle="modal" data-target="#add_mission">
										<div class="container_missions">
											<div class="heures_missions">` + heures_debutFin_missions_bdd + `</div>
											<div class="status">Terminée</div>
										</div>	
								</button>`]);
						}
					}

				{% endfor %}
				if (present) {
					var id_grid = "{{ consultant.user_django.prenom }} " + "{{ consultant.user_django.nom }}" + '/' + jours_chiffres.toString() + '/' + mois.toString()  + '/' + annee.toString();
					var grid = [`<div class="grid" style="height:` + height_ligne + `px;" id="` + id_grid + `"></div>`];

					grid.push();
					document.getElementById("line_grids" + i ).insertAdjacentHTML(start_or_end, grid);

					for (let m = 0 ; m < one_mission_grid.length ; m++) {
 						document.getElementById(id_grid).insertAdjacentHTML(start_or_end, one_mission_grid[m]);
					}
				}
				else{
					var grid = [`<div class="grid" style="height:` + height_ligne + `px;" id="` + "{{ consultant.user_django.prenom }} " + "{{ consultant.user_django.nom }}" + `/` + jours_chiffres.toString() + `/` + mois.toString()  + `/` + annee.toString() + `"></div>`];
					grid.push();
					document.getElementById("line_grids" + i ).insertAdjacentHTML(start_or_end, grid);
				}
											
			{% endfor %}
			

			// CASES DATES GUAUCHES
		  	month_j_moins1 = moment().add(i-1,'days').format("M"); // on recupère le mois du jour d'avant
		  	month_j_moins3 = moment().add(i-3,'days').format("M"); // cas du lundi
		  	if(month_j_moins1 != mois_one_num || jours_lettres[0] == 'l' && month_j_moins3 != mois_one_num){ // si le mois du jours d'avant est différent du jour même dans la var "mois" ou on est lundi est le vendredi avant le lundi est un mois différent	  		
				var new_code = [`<div id="mois_` + mois_one_num +  `" class="jours" style="height:` + height_ligne + `px;"><div class="texte_jours">` + jours_lettres.toString() + `</div><div class="texte_jours">`  + jours_chiffres.toString() + `</div></div>`]; // on ajoute un id pour le fonctionnement du chgmt de mois lors du scroll			 
		  	}
		  	else{
		  		if(i == today){ // si on est au jour d'ojd, on le caractérise dans l'id (permet le fonctionnement de l'option "j'arrive sur ojd quand je charge la page")
					var new_code = [`<div id="today" class="jours" style="height:` + height_ligne + `px;"><div class="texte_jours">` + jours_lettres.toString() + `</div><div class="texte_jours">`  + jours_chiffres.toString() + `</div></div>`];
					console.log("t chaud");
				}
				else{
				// Création et implémentation de la date (bord guauche du planning)
		  		var new_code = [`<div class="jours" style="height:` + height_ligne + `px;"><div class="texte_jours">` + jours_lettres.toString() + `</div><div class="texte_jours">`  + jours_chiffres.toString() + `</div></div>`];
				}  				
		  	}
		
			new_code.push();
			document.getElementById("first_table").insertAdjacentHTML(start_or_end,new_code);

			// quand on arrive sur vendredi on ajoute une ligne vide pour séparer les semaines
		  	if(jours_lettres[0] == 'v'){ 
		  		nbre_weekend +=1; //un incrémente de 1 le nombre de weekend
				// Ligne où il n'y a pas de jour donc ligne vide --> BLOC PRINCIPAL AVEC MISSIONS
				var parent_line_grid_empty = [`<div class="line_grids" id="no_line` + i + `"></div>`]; //changement d'id pour la ligne vide
				parent_line_grid_empty.push()
				document.getElementById("grids").insertAdjacentHTML(start_or_end, parent_line_grid_empty); //on incrémente la ligne vide

				// on implémente les cases de la lignes vides avec juste un border bottom
				{% for consultant in consultants %}			
					no_line.push()
					document.getElementById("no_line" + i).insertAdjacentHTML(start_or_end, no_line);
				{% endfor %}

				// Création et implémentation de la transition de semaine (les trois traits) -> COLONNE DE GUAUCHE		
		  		var space_line = [`<div id="space` + nbre_weekend + `" class="jours"><span style="text-align:center;" class="texte_jours"> --- </span></div>`];
				space_line.push();
				document.getElementById("first_table").insertAdjacentHTML(start_or_end,space_line);
				i+=2; // pas de weekend donc on passe directement au lundi			
		  	}	
		}
	}

	var nombre_lignes_total = (-nombre_jours_affiches_passe) + nombre_jours_affiches_futur - nbre_weekend; // permet de calculer le nombre de lignes exact (en enlevant une ligne à chaque weekend, une ligne car on implémente une ligne vide)
	loadTab(nombre_jours_affiches_passe, nombre_jours_affiches_futur, 'beforeend'); //on implemente le premier chargement du planning
	

	function deleteFirstElements(){	// SUPPRESSION DE LA MOITIE DES PREMIERES CASES	

	   	for(let i = 1; i <= nombre_lignes_total / 2 ; i++){
	   		var date_left_side = document.getElementById('first_table').children[1];
			var line_gids = document.getElementById('grids').children[1];
			date_left_side.parentNode.removeChild(date_left_side);
			line_gids.parentNode.removeChild(line_gids);
	   	}

	}

	function deleteLastElements(){ // SUPPRESSION DE LA MOITIE DES DERNIERES CASES	
		for(let i = 1; i <= nombre_lignes_total / 2 ; i++){
	   		var date_left_side = document.getElementById('first_table').lastChild;
			var line_gids = document.getElementById('grids').lastChild;
			date_left_side.parentNode.removeChild(date_left_side);
			line_gids.parentNode.removeChild(line_gids);
	   	}
	}

	//quand on atteint le bottom du scroll on charge les nouvelles données (suppression + ajout de lignes)
	jQuery(function($) {
		$('#table').on('scroll', function() {
			if($(this).scrollTop() + $(this).innerHeight() >= $(this)[0].scrollHeight) {
				deleteFirstElements();
				var nbr = nombre_jours_affiches_futur + nombre_lignes_total / 2 + nbre_weekend;
			    loadTab(nombre_jours_affiches_futur, nbr, 'beforeend');
			    nombre_jours_affiches_passe = nombre_jours_affiches_futur;
			    nombre_jours_affiches_futur = nbr;
			    nbre_weekend = 0;
			}
			else if($(this).scrollTop() == 0){

				var consultants_grids = document.getElementById('grids').firstChild;
				consultants_grids.parentNode.removeChild(consultants_grids);
				deleteLastElements();
				var nbr = nombre_jours_affiches_futur + nombre_lignes_total / 2 + nbre_weekend;
				loadTab(nombre_jours_affiches_futur, nbr, 'afterbegin');
			    nombre_jours_affiches_passe = nombre_jours_affiches_futur;
			    nombre_jours_affiches_futur = nbr;
			    nbre_weekend = 0;

			    var consultants_line = [`<span class="second_table" id="table_consultants"></span>`];
			    document.getElementById('grids').insertAdjacentHTML('afterbegin',consultants_line);
			    // Affichage des consultants dans la barre du dessus
				{% for consultant in consultants %}
						var new_code_consultants = [`<div class="consultants">` + "{{ consultant.user_django.prenom }} " + "{{ consultant.user_django.nom }}"+ `</div>`];
						new_code_consultants.push();
						document.getElementById('table_consultants').insertAdjacentHTML('beforeend',new_code_consultants);
				{% endfor %}
				
			}
		})
	});



	// fonctionnement du chgmt de mois lors du scroll
	$(window).bind('mousewheel', function(event) {
		if (event.originalEvent.wheelDelta >= 0) { // scroll vers le haut (donc les dates descendent)

		    console.log('Scroll up');		    
		    for (var i = 1; i <= 12 ; i++) {

		    	var mois_scrollup = document.getElementById("mois_" + i); 
		    	try {
		    		var div_top_scrollup = document.getElementById("case_jours");
				  	var offsetTop_mois_scrollup = mois_scrollup.offsetTop; // calcul la distance entre les haut du tableau et la mois visé
				}
				catch(error) {
				  	console.log("Ok");

				  // expected output: ReferenceError: nonExistentFunction is not defined
				  // Note - error messages will vary depending on browser
				}
		    			    	
		    	var offsetTop_top_scrollup = div_top_scrollup.offsetTop; // calcul la distance entre les haut du tableau et la case jours
		    	var diff_bottom_top_scrollup = offsetTop_mois_scrollup - offsetTop_top_scrollup;  // calcul de la distance entre la div visée et la case "Jours" (parait inutilie mais fait fonctionner le bail)
		    	console.log("mois" + i + " : " + diff_bottom_top_scrollup);
				if (document.getElementById(i).className == "mois this_month" && diff_bottom_top_scrollup > 27) {
					for (var n = 1; n <= 12; n++) {
						document.getElementById(n).className = "mois";
					}
					if(i != 1)//pas janvier
						document.getElementById(i-1).className += " this_month"; // on remonte sur decembre donc pas sur i-1
					else //janvier
						document.getElementById(12).className += " this_month";
				}
		    }
		}
		else {	 // scroll vers le bas (donc les dates montent)
											  
		    console.log('Scroll down');
		    for (var i = 1 ; i <= 12 ; i++) {
		    	var mois = document.getElementById("mois_" + i);
		    	try {
		    		var div_top = document.getElementById("case_jours");
				  	var offsetTop_mois = mois.offsetTop; // calcul la distance entre les haut du tableau et la mois visé
				}
				catch(error) {
					console.log("Ok");

				  // expected output: ReferenceError: nonExistentFunction is not defined
				  // Note - error messages will vary depending on browser
				}
		    	var offsetTop_top = div_top.offsetTop;
		    	var diff_bottom_top = offsetTop_mois - offsetTop_top;  // calcul de la distance entre la div visée et la case "Jours"
		    	console.log("mois" + i + " : " + diff_bottom_top);
		    	if (diff_bottom_top  <= 27 && diff_bottom_top  > 0 && document.getElementById(i).className != "mois this_month") {
		    		for (var n = 1; n <= 12; n++) {
						document.getElementById(n).className = "mois";
					}
				    document.getElementById(i).className += " this_month";				    
				}
		    }	    
		}
	});

	
	function clickOnMonth(id_month){
		for (var n = 1; n <= 12; n++) {
			document.getElementById(n).className = "mois";
		}
		document.getElementById(id_month).className += " this_month";
		document.getElementById("table").scrollTop -= 100;
	} 
	// lors du chargement de la page, on arrive directement sur le jour d'ojd
	var today = document.getElementById("today"); // !!!!!! PROBLEME LE DIMANCHE OU QUAND TODAY + CHGM DE MOIS
  	today.scrollIntoView(); //on scoll a la div d'ojd 
  	document.getElementById("table").scrollTop -= 26; //on scroll de 26 px de plus parce le jours s'affiche sous la barre du haut du planning
	

</script>

{% endblock %}

