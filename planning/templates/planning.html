{% extends 'base_planning.html' %}
{% load staticfiles %}

{% block link %}
<link href="{% static 'planning/css/planning.css' %}" rel="stylesheet">
{% endblock %}

{% block content %}
<style>

  .calendar {
    margin: 40px 10px;
    padding: 0;
    font-family: Arial, Helvetica Neue, Helvetica, sans-serif;
    font-size: 14px;
  }

  #calendar {
    max-width: 900px;
    margin: 0 auto;
  }

  p{
  	margin-bottom: 0;
  }

</style>


<section class="really_all_planning">
	<div class="navbar_planning">

		<ul class="all_first_line">
			<li class="titre_buttons">
				<p class="titre">Planning 2020</p>
			</li>
			<span class="buttons">
				<li class="titre_buttons">
					<a href="#" data-toggle="modal" data-target="#terms-txt" style="height: 45px;cursor: pointer;float: right;color: #222;padding: 5px 12px 5px 12px; border-style: solid;">
						<div class="container_filter_button">
							<em style="color: black;font-size: 21px;margin-right: 4px;" class="icon-plus"></em>
							<p>Filter</p>
						</div>
					</a>
				</li>
				<li class="titre_buttons">
					<a href="#" data-toggle="modal" data-target="#terms-txt2" style="cursor: pointer;float: right;color: #222;padding: 5px 12px 5px 12px;border-radius: 100%;"><em style="color: black;font-size: 37px;" class="icon-cloud-upload"></em>
					</a>
				</li>
				<li class="titre_buttons">
					<a href="#" data-toggle="modal" data-target="#add_mission" style="cursor: pointer;float: right;color: #222;padding: 5px 12px 5px 12px;border-radius: 100%;"><em style="color: black;font-size: 37px;" class="icon-plus"></em>
					</a>
				</li>
			</span>
		</ul>


		<div class="all_second_line">
			<div class="titre_buttons">
				<a class="mois" id="1" style="border-left: solid;border-left-width: 1px;border-left-color: #ddd;">			
					<p>Janvier</p>
				</a>
			</div>
			<div class="titre_buttons">
				<a class="mois" id="2">			
					<p>Février</p>
				</a>
			</div>
			<div class="titre_buttons">
				<a class="mois" id="3">			
					<p>Mars</p>
				</a>
			</div>
			<div class="titre_buttons">
				<a class="mois" id="4">			
					<p>Avril</p>
				</a>
			</div>
			<div class="titre_buttons">
				<a class="mois" id="5">			
					<p>Mai</p>
				</a>
			</div>
			<div class="titre_buttons">
				<a class="mois" id="6">			
					<p>Juin</p>
				</a>
			</div>
			<div class="titre_buttons">
				<a class="mois" id="7">			
					<p>Juillet</p>
				</a>
			</div>
			<div class="titre_buttons">
				<a class="mois" id="8">			
					<p>Août</p>
				</a>
			</div>
			<div class="titre_buttons">
				<a class="mois" id="9">			
					<p>Septembre</p>
				</a>
			</div>
			<div class="titre_buttons">
				<a class="mois" id="10">			
					<p>Octobre</p>
				</a>
			</div>
			<div class="titre_buttons">
				<a class="mois" id="11">			
					<p>Novembre</p>
				</a>
			</div>
			<div class="titre_buttons">
				<a class="mois"  id="12">			
					<p>Décembre</p>
				</a>
			</div>
		</div>
	</div>


	<div class="table" id="table">

		<div class="first_table" id="first_table">
			<span class="case_jours" id="case_jours">Jours</span>

			<!-- Les dates des jours -->

		</div>

		<div class="formateurs_grids" id="grids">

			<!-- Les formateurs -->
			<span class="second_table" id="table_formateurs">				
			</span>

			<!-- Toutes les cases  -->

		</div>

	</div>
</section>

<!-- forme d'une mission dans le planning -->
<!-- <button class="missions" data-toggle="modal" data-target="#terms-txt"> Lorem Ipsum </button> -->


<!-- Template de la pop-up -->
<i class="icone-plus"></i>
<div class="modal fade" id="add_mission" tabindex="-1" role="dialog" aria-labelledby="termsLabel" aria-hidden="true">
	<div class="modal-dialog modal-dialog-centered">
		<div class="modal-content">
			<div class="modal-header">
				<h4 class="modal-title" id="termsLabel">Ajouter une mission</h4>
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
			</div>
			<div class="modal-body">
				<!-- <form class="add_form" method="post" action="{% url 'planning' %}"> {% csrf_token %}
					<label>Titre</label>
					<input type="text" name="titre" id="titre_mission">

					<label>Consultant</label>
					<input type="consultant" name="consultant" id="consultant_mission">

					<label>Date</label>
					<input type="date" name="date" id="date_mission" value="{% now 'Y-m-d' %}">
					<input type="submit" name="ajouter_mission" value="Ajouter">
				</form> -->
				<!-- <form action="{% url 'planning' %}" method="post" enctype="multipart/form-data">
				    {% csrf_token %}
				    {{ form.as_p }}
				    <input type="submit" name="ajouter_mission" value="Submit">
				</form> -->
				<form action="{% url 'planning' %}" method="post" enctype="multipart/form-data">
				    {% csrf_token %}
				    <p>
				    	<label for="id_nom">Nom&nbsp;:</label> 
				    	<input type="text" name="nom" value=" " maxlength="400" required="" id="id_nom">
				    </p>
					<p>
						<label for="id_description">Description&nbsp;:</label> <textarea name="description" required="" rows="10" id="id_description" cols="40" style="margin-top: 2px; margin-bottom: 2px; height: 137px;"></textarea></p>
					<p>
						<label for="id_formateur">Formateur&nbsp;:</label>
						<input type="text" name="formateur" value=" " maxlength="400" required="" id="id_formateur">
					</p>
					<p>
						<label for="id_date">Date d'envoi&nbsp;:</label>
						<input type="datetime-local" name="date" required="" id="id_date">
					</p>

					<input type="submit" name="ajouter_mission" value="Submit">
				</form>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn_1" data-dismiss="modal">Fermer</button>
			</div>
		</div>

	</div>
</div>


{% endblock %}


{% block script %} 
<script src="{% static 'planning/js/moment-with-locales.min.js' %}"></script> <!-- import de moment.js pour les dates -->
<script type="text/javascript">

	var nbre_weekend = 0;//permet le fonctionnement du chargement de données

	var nombre_jours_affiches_futur = 200;
	var nombre_jours_affiches_passe = -30;

	// permet le fonctionnement de la fonction "on arrive sur ojd quand on charge la page"
	let jours_lettres_ojd = moment().format("ddd");
	var today = -1;

	if(jours_lettres_ojd[0] == 's') // si on est samedi on avance de 2 jours pour afficher lundi qui arrive
		today -= 1;
	else if(jours_lettres_ojd[0] == 'd') // si on est dimanche on avance de 1 jours pour afficher lundi qui arrive
		today -= 2;
	


	// Affichage des formateurs dans la barre du dessus
	{% for formateur in formateurs %}
			var new_code_formateurs = [`<div class="formateurs">` + "{{ formateur.nom }}" + `</div>`];
			new_code_formateurs.push();
			document.getElementById("table_formateurs").insertAdjacentHTML('beforeend',new_code_formateurs);
	{% endfor %}

	moment.locale('fr'); // definition de l'heure française

	// mettre en couleur le mois ou on se trouve
	let date = moment().format("M");
	document.getElementById(date).className += " this_month";

	var no_line = [`<div class="no_line"><label style="opacity:0;">Invisible</label></div>`];
	
	function loadTab(nombre_jours_affiches_passe, nombre_jours_affiches_futur){
		for (let i = nombre_jours_affiches_passe ; i < nombre_jours_affiches_futur; i++) { // nombre de jours chargés

			// PARENTS D'UNE LIGNE -> ON Y FOUT LES CASES APRES
			var parent_line_grid = [`<div class="line_grids" id="line_grids` + i + `"></div>`];
			parent_line_grid.push();
			document.getElementById("grids").insertAdjacentHTML('beforeend', parent_line_grid);
		
			// variables pour les dates
		  	let jours_lettres = moment().add(i,'days').format("ddd"); // ex : lun.
		  	let jours_chiffres = moment().add(i,'days').format("DD"); // 01,02,...,31
		  	let mois = moment().add(i,'days').format("MM"); // 01,02,...,12
		  	let mois_one_num = moment().add(i,'days').format("M"); // 1,2,...,12
		  	let annee = moment().add(i,'days').format("YYYY"); // 98,99,00,...,19,20

		  	var nbr_missions = 0;
		  	var nbr_mission_oneDay = 0;
		  	var nbr_mission_oneDay_max = 0;
		  	var date_mission_case = annee.toString() + '-'+  mois.toString() + '-' + jours_chiffres.toString();

		  	var formateur_mission_bdd = "";
		  	// on cherche a savoir le nbr de missions maximale contenu dans une journée pour adapter la taille des cases
		  	{% for formateur in formateurs %}
		  		var formateur_mission_bdd = '';
		  		{% for mission in missions %}		  			
		  			var date_heure_mission_bdd = "{{ mission.date }}"; // DATE + HEURE DE LA MISSION DANS LA BASE DE DONNEE (2020-02-26 17:30:00)
		  			var date_mission_bdd = date_heure_mission_bdd.substring(0,10); //ON RECUPERE QUE LA DATE (2020-02-26)
		  			var formateur_mission_case = "{{ formateur.nom }}";
		  			
		  			if (date_mission_case == date_mission_bdd && ("{{ mission.formateur }}" == formateur_mission_bdd && formateur_mission_case == "{{ mission.formateur }}" || nbr_mission_oneDay == 0 && formateur_mission_case == "{{ mission.formateur }}")) {
						nbr_mission_oneDay += 1;					
					}
					formateur_mission_bdd = "{{ mission.formateur }}";
				{% endfor %}
				nbr_mission_oneDay_max = Math.max(nbr_mission_oneDay, nbr_mission_oneDay_max);
				nbr_mission_oneDay = 0;

			{% endfor %}

			
			var height_ligne = nbr_mission_oneDay_max * 28 + nbr_mission_oneDay_max;
			if(nbr_mission_oneDay_max == 0 || nbr_mission_oneDay_max == 1)
				height_ligne = 28 + nbr_mission_oneDay_max ;

			
		  	// CASES DANS UNE LIGNE
		  	{% for formateur in formateurs %}
		  		var present = false;
		  		var one_mission_grid = [];
		  		{% for mission in missions %}

		  			nbr_missions += 1; //fonction modifs mission
		  			var date_mission_case = annee.toString() + '-'+  mois.toString() + '-' + jours_chiffres.toString(); // DATE DE LA LIGNE DU PLANING OU ON SE SITUE
		  			var date_heure_mission_bdd = "{{ mission.date }}"; // DATE + HEURE DE LA MISSION DANS LA BASE DE DONNEE (2020-02-26 17:30:00)
		  			var date_mission_bdd = date_heure_mission_bdd.substring(0,10); //ON RECUPERE QUE LA DATE (2020-02-26)

		  			var formateur_mission_case = "{{ formateur.nom }}";
		  			var formateur_mission_bdd = "{{ mission.formateur }}";
		  			if (date_mission_case == date_mission_bdd && formateur_mission_case == formateur_mission_bdd) {
						var present = true;
						var nom_mission = "{{ mission.nom }}"; //PERMET D'AFFICHER LE NOM DE LA MISSION SUR LE PLANNING
						var id_mission = "{{ mission.id }}"; //MODIFIER UNE MISSION
						one_mission_grid.push([`<button draggable="true" id="mission_` + id_mission + `" class="missions" data-toggle="modal" data-target="#add_mission"> ` + nom_mission + ` </button>`]);
					}

				{% endfor %}
				if (present) {
					var id_grid = "{{ formateur.nom }}" + '/' + jours_chiffres.toString() + '/' + mois.toString()  + '/' + annee.toString();
					var grid = [`<div class="grid" style="height:` + height_ligne + `px;" id="` + id_grid + `"></div>`];

					grid.push();
					document.getElementById("line_grids" + i ).insertAdjacentHTML('beforeend', grid);

					for (let m = 0 ; m < one_mission_grid.length ; m++) {
 						document.getElementById(id_grid).insertAdjacentHTML('beforeend', one_mission_grid[m]);
					}
				}
				else{
					var grid = [`<div class="grid" style="height:` + height_ligne + `px;" id="` + "{{ formateur.nom }}" + `/` + jours_chiffres.toString() + `/` + mois.toString()  + `/` + annee.toString() + `"></div>`];
					grid.push();
					document.getElementById("line_grids" + i ).insertAdjacentHTML('beforeend', grid);
				}
											
			{% endfor %}
			

			// CASES DATES GUAUCHES
		  	month_j_moins1 = moment().add(i-1,'days').format("M"); // on recupère le mois du jour d'avant
		  	month_j_moins3 = moment().add(i-3,'days').format("M"); // cas du lundi
		  	if(month_j_moins1 != mois_one_num || jours_lettres[0] == 'l' && month_j_moins3 != mois_one_num){ // si le mois du jours d'avant est différent du jour même dans la var "mois" ou on est lundi est le vendredi avant le lundi est un mois différent	  		
				var new_code = [`<div id="mois_` + mois_one_num +  `" class="jours" style="height:` + height_ligne + `px;"><span class="texte_jours">` + jours_lettres.toString() +`   `  + jours_chiffres.toString() + "/"  + mois_one_num.toString() + `</span></div>`]; // on ajoute un id pour le fonctionnement du chgmt de mois lors du scroll			 
		  	}
		  	else{
		  		if(i == today){ // si on est au jour d'ojd, on le caractérise dans l'id (permet le fonctionnement de l'option "j'arrive sur ojd quand je charge la page")
					var new_code = [`<div id="today" class="jours" style="height:` + height_ligne + `px;"><span class="texte_jours">` + jours_lettres.toString() +`   `  + jours_chiffres.toString() + "/"  + mois.toString() + `</span></div>`];
				}
				else{
				// Création et implémentation de la date (bord guauche du planning)
		  		var new_code = [`<div class="jours" style="height:` + height_ligne + `px;"><span class="texte_jours">` + jours_lettres.toString() +`   `  + jours_chiffres.toString() + "/"  + mois.toString() + `</span></div>`];
				}  				
		  	}
		
			new_code.push();
			document.getElementById("first_table").insertAdjacentHTML('beforeend',new_code);

			// quand on arrive sur vendredi on ajoute une ligne vide pour séparer les semaines
		  	if(jours_lettres[0] == 'v'){ 
		  		nbre_weekend +=1; //un incrémente de 1 le nombre de weekend
				// Ligne où il n'y a pas de jour donc ligne vide --> BLOC PRINCIPAL AVEC MISSIONS
				var parent_line_grid_empty = [`<div class="line_grids" id="no_line` + i + `"></div>`]; //changement d'id pour la ligne vide
				parent_line_grid_empty.push()
				document.getElementById("grids").insertAdjacentHTML('beforeend', parent_line_grid_empty); //on incrémente la ligne vide

				// on implémente les cases de la lignes vides avec juste un border bottom
				{% for formateur in formateurs %}			
					no_line.push()
					document.getElementById("no_line" + i).insertAdjacentHTML('beforeend', no_line);
				{% endfor %}

				// Création et implémentation de la transition de semaine (les trois traits) -> COLONNE DE GUAUCHE		
		  		var space_line = [`<div id="space` + nbre_weekend + `" class="jours"><span style="text-align:center;" class="texte_jours"> --- </span></div>`];
				space_line.push();
				document.getElementById("first_table").insertAdjacentHTML('beforeend',space_line);
				i+=2; // pas de weekend donc on passe directement au lundi			
		  	}	
		}
	}

	var nombre_lignes_total = (-nombre_jours_affiches_passe) + nombre_jours_affiches_futur - nbre_weekend; // permet de calculer le nombre de lignes exact (en enlevant une ligne à chaque weekend, une ligne car on implémente une ligne vide)
	loadTab(nombre_jours_affiches_passe, nombre_jours_affiches_futur); //on implemente le premier chargement du planning
	

	function deleteFirstElements(){	// SUPPRESSION DE LA MOITIE DES PREMIERESCASES	

	   	for(let i = 1; i <= nombre_lignes_total / 2 ; i++){
	   		var date_left_side = document.getElementById('first_table').children[1];
			var line_gids = document.getElementById('grids').children[1];
			date_left_side.parentNode.removeChild(date_left_side);
			line_gids.parentNode.removeChild(line_gids);
	   	}

	}

	//quand on atteint le bottom du scroll on charge les nouvelles données (suppression + ajout de lignes)
	jQuery(function($) {
		$('#table').on('scroll', function() {
			if($(this).scrollTop() + $(this).innerHeight() >= $(this)[0].scrollHeight) {
				deleteFirstElements();
				var nbr = nombre_jours_affiches_futur + nombre_lignes_total / 2 + nbre_weekend;
			    loadTab(nombre_jours_affiches_futur, nbr);
			    nombre_jours_affiches_passe = nombre_jours_affiches_futur;
			    nombre_jours_affiches_futur = nbr;
			    nbre_weekend = 0;
			}
		})
	});	

	// fonctionnement du chgmt de mois lors du scroll
	$(window).bind('mousewheel', function(event) {
		if (event.originalEvent.wheelDelta >= 0) { // scroll vers le haut (donc les dates descendent)

		    // console.log('Scroll up');		    
		    for (var i = 1; i <= 12 ; i++) {

		    	var mois = document.getElementById("mois_" + i); 
		    	try {
		    		var div_top = document.getElementById("case_jours");
				  	var offsetTop_mois = mois.offsetTop; // calcul la distance entre les haut du tableau et la mois visé
				}
				catch(error) {
				  	console.log("Ok");

				  // expected output: ReferenceError: nonExistentFunction is not defined
				  // Note - error messages will vary depending on browser
				}
		    			    	
		    	var offsetTop_top = div_top.offsetTop; // calcul la distance entre les haut du tableau et la case jours
		    	var diff_bottom_top = offsetTop_mois - offsetTop_top;  // calcul de la distance entre la div visée et la case "Jours" (parait inutilie mais fait fonctionner le bail)
				if (document.getElementById(i).className == "mois this_month" && diff_bottom_top > 300) {
					for (var n = 1; n <= 12; n++) {
						document.getElementById(n).className = "mois";
					}
					if(i != 1)//pas janvier
						document.getElementById(i-1).className += " this_month"; // on remonte sur decembre donc pas sur i-1
					else //janvier
						document.getElementById(12).className += " this_month";
				}
		    }
		}
		else {	 // scroll vers le bas (donc les dates montent)
											  
		    // console.log('Scroll down');
		    for (var i = 1 ; i <= 12 ; i++) {
		    	var mois = document.getElementById("mois_" + i);
		    	try {
		    		var div_top = document.getElementById("case_jours");
				  	var offsetTop_mois = mois.offsetTop; // calcul la distance entre les haut du tableau et la mois visé
				}
				catch(error) {
					console.log("Ok");

				  // expected output: ReferenceError: nonExistentFunction is not defined
				  // Note - error messages will vary depending on browser
				}
		    	var offsetTop_top = div_top.offsetTop;
		    	var diff_bottom_top = offsetTop_mois - offsetTop_top;  // calcul de la distance entre la div visée et la case "Jours"
		    	if (diff_bottom_top  <= 300 && diff_bottom_top  > 0 && document.getElementById(i).className != "mois this_month") {
		    		for (var n = 1; n <= 12; n++) {
						document.getElementById(n).className = "mois";
					}
				    document.getElementById(i).className += " this_month";				    
				}
		    }	    
		}
	});

	

	    
	// lors du chargement de la page, on arrive directement sur le jour d'ojd
	var today = document.getElementById("today"); // !!!!!! PROBLEME LE DIMANCHE OU QUAND TODAY + CHGM DE MOIS
  	today.scrollIntoView();

</script>

{% endblock %}

